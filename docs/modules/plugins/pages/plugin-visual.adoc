:visual-testing-actions: `ESTABLISH`, `COMPARE_AGAINST` and `CHECK_INEQUALITY_AGAINST`
= Visual Testing Plugin

The plugin for visual testing.

== Installation

.build.gradle
[source,gradle,subs="attributes+"]
----
implementation(group: 'org.vividus', name: 'vividus-plugin-visual', version: '{current-version}')
----

== Properties

[cols="3,1,1,3", options="header"]
|===
|Property Name
|Acceptable values
|Default
|Description

|`ui.visual.ignored-elements`
|xref:plugin-web-app.adoc#_locator[locators]
|`<empty>`
|The comma-separated list of locators of elements to ignore element areas

|`ui.visual.ignored-areas`
|xref:plugin-web-app.adoc#_locator[locators]
|`<empty>`
|The comma-separated list of locators of elements to ignore page areas

|`ui.visual.baselines-folder`
|`string`
|`./baseline`
|The path to folder for saving baselines (root folder is `src/main/resources`).
For example, `ui.visual.baselines-folder=C:/Workspace/vividus-tests/src/main/resources/baselines`

|`ui.visual.indexer`
|scenario
|`<empty>`
|Used to append scenario based index to a baseline name

|`ui.visual.override-baselines`
a|`true`
`false`
|`false`
|Used for overriding existing ones or creating not existing baselines during compare action

|`ui.visual.acceptable-diff-percentage`
|percentage numbers
|`0`
|Add ability to configure sensitivity for visual checks

|`ui.visual.required-diff-percentage`
|percentage numbers
|`70`
|Defines required difference baseline vs checkpoint to consider them inequal

|`ui.screenshot.debug-directory`
|`string`
|`<empty>`
|The path to folder for saving debug screenshots. For example, `ui.screenshot.debug-directory=C:/temp/debug`

|`ui.visual.baseline-repository`
|Any available baseline repository name.
|`filesystem`
|Allows to override default xref:developer-guides:plugins.adoc#_baseline_repositories[baseline repository].

|===

== How to use

The plugin has the following actions: {visual-testing-actions}

include::partial$establish.adoc[]

Steps to establish baseline:

. Run step `When I ESTABLISH baseline with name `name``
. Open report

image::report_establish.png[Allure report with visual check on establish]

. Save image using `contextual mouse click` -> Save as into folder for baselines

image::establish_baseline.png[Baseline view]

image::save_baseline.png[Saving baseline]

include::partial$compare-against.adoc[]

Steps to compare baseline:

. Run step `When I COMPARE_AGAINST baseline with name `name``
. Open report

image::report_compare.png[Allure report with visual check on compare]

. Review comparison results

image::comparison_result.png[Comparison result view]

. If you need to accept the new baseline:

a) Switch to checkpoint view

image::checkpoint.png[Checkpoint view]

b) Contextual click on the checkpoint image -> save as to baseline folder

include::partial$check-inequality-against.adoc[]

== Visual testing with custom shooting strategies

In order to support screenshot taking configuration per-project/per-step basis framework provides following approach.

=== Web Applications

Property based configuration could be specified using `web.screenshot.strategy.<YOUR_STRATEGY_NAME>.<PROPERTY_NAME>= pattern`,
where:
`YOUR_STRATEGY_NAME` - name of the custom strategy;
`PROPERTY_NAME` - name of the property you want specify.

==== Properties based configuration:

[cols="3,1,3", options="header"]
|===
|Property Name
|Acceptable values
|Description

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.web-header-to-cut`
|size in pixels
|Web header to cut (could be useful if your site has sticky header)

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.web-footer-to-cut`
|size in pixels
|Web footer to cut (could be useful if your site has sticky footer)

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.native-header-to-cut`
|size in pixels
|Native header to cut

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.native-footer-to-cut`
|size in pixels
|Native footer to cut

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.coords-provider`
|`WEB_DRIVER` `CEILING`
|Adds margins to coordinates, default one

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.scroll-timeout`
|time in millis
|Timeout for scrolling during performing visual check

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.scrollable-element`
|locator
|Locator of element for performing scroll action during visual check, steps fails if an element by the locator does not exist

|`web.screenshot.strategy.<YOUR_STRATEGY_NAME>.shooting-strategy`
|`SIMPLE` `VIEWPORT_PASTING`
|Screenshot shooting strategy name (`VIEWPORT_PASTING` by default)

|`web.screenshot.strategy=YOUR_STRATEGY_NAME`
|string
|After configuration necessary properties use this one to enable your custom strategy

|===

==== Step based configuration

To use custom configuration per step, two new steps were implemented.

[source,gherkin]
----
When I $visualAction baseline with `$baselineName` using screenshot configuration:$screenshotConfiguration
----

[source,gherkin]
----
When I $visualAction baseline with `$baselineName` ignoring:$ignoringElement using screenshot configuration:$screenshotConfiguration
----

==== *Examples of usage property based configuration:*

[source,gherkin]
----
web.screenshot.strategy.bombaysapphire.web-header-to-cut=80
web.screenshot.strategy.bombaysapphire.web-footer-to-cut=0
web.screenshot.strategy.bombaysapphire.scrollable-element=By.cssSelector(.page__inner)
web.screenshot.strategy.bombaysapphire.scroll-timeout=PT1S
web.screenshot.strategy.bombaysapphire.shooting-strategy=SIMPLE
web.screenshot.strategy=bombaysapphire
----

==== *Examples of usage step based configuration:*

[source,gherkin]
----
When I <action> baseline with `scrollable-element-context` using screenshot configuration:
|scrollableElement                    |webHeaderToCut|webFooterToCut|scrollTimeout|shootingStrategy|
|By.xpath(//div[@class="page__inner"])|80            |0             |PT1S         |SIMPLE          |
----

Please see the image to get a clue about difference between native/web footer/header to cut.

image::example.png[Difference between native/web footer/header image]

=== Mobile Native Applications

==== Properties

[cols="3,1,1,3", options="header"]
|===
|Property Name
|Acceptable values
|Default
|Description

|`mobile.screenshot.downscale`
|`boolean`
|`true`
|Downscale checkpoint image according to a device https://developer.mozilla.org/en-US/docs/Web/API/Window/devicePixelRatio[DPR] value
|===

Please see the image to get a clue about difference between original and downscaled images.

image::original_and_downscaled_checkpoints.png[Difference between original and dpr downscaled image]

Property based configuration could be specified using `mobile.screenshot.strategy.<YOUR_STRATEGY_NAME>.<PROPERTY_NAME>= pattern`,
where:
`YOUR_STRATEGY_NAME` - name of the custom strategy;
`PROPERTY_NAME` - name of the property you want specify.

==== Properties based configuration:

[cols="3,1,3", options="header"]
|===
|Property Name
|Acceptable values
|Description

|`mobile.screenshot.strategy.<YOUR_STRATEGY_NAME>.native-footer-to-cut`
|size in pixels
|Native footer to cut

|`mobile.screenshot.strategy.<YOUR_STRATEGY_NAME>.shooting-strategy`
|`SIMPLE`
|Screenshot shooting strategy name (`SIMPLE` by default)

|`mobile.screenshot.strategy=YOUR_STRATEGY_NAME`
|string
|After configuration necessary properties use this one to enable your custom strategy

|===

==== *Examples of usage property based configuration:*

[source,gherkin]
----
mobile.screenshot.strategy.bombaysapphire.native-footer-to-cut=100
mobile.screenshot.strategy.bombaysapphire.shooting-strategy=SIMPLE
mobile.screenshot.strategy=bombaysapphire
----

==== *Examples of usage step based configuration:*

[source,gherkin]
----
When I <action> baseline with `scrollable-element-context` using screenshot configuration:
|nativeFooterToCut|shootingStrategy|
|51               |SIMPLE          |
----

==== Strategies

[cols="1,3", options="header"]
|===

|Name
|Description

|`SIMPLE`
|Used to take a screenshot of current viewport. This strategy is used by default.

|`FULL`
|Used to take a screenshot of whole application view. The strategy starts shooting at the top position 
of the application view and ends at the bottom position, once the shooting is done the initial top position 
gets restored.

For iOS platform make sure to set the `screenshotQuality` property to `0` to ensure screenshot pixels 
consistensy, please see https://github.com/appium/appium-xcuitest-driver[XCUI capabililties] for more details.

|===

== Steps

=== Run simple visual test

Establishes baseline or compares against existing one.

[source,gherkin]
----
When I $actionType baseline with name `$name`
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - Then name of baseline.

.Perform simple visual check on compare
[source,gherkin]
----
When I COMPARE_AGAINST baseline with name `test`
----

=== Run simple visual test with custom baseline repository

Establishes baseline or compares against existing one using xref:developer-guides:plugins.adoc#_baseline_repositories[baseline repository].

[source,gherkin]
----
When I $actionType baseline with name `$name` using repository `$repository`
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$repository` - The name of repository. Ony `filesystem` available by the default.

.Perform simple visual check using baseline repository
[source,gherkin]
----
When I COMPARE_AGAINST baseline with name `test` using repository `azure`
----

=== Run visual test with specified configuration

Establishes baseline or compares against existing one using the specified configuration.

[source,gherkin]
----
When I $actionType baseline with name `$name` using screenshot configuration:$screenshotConfiguration
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$screenshotConfiguration` - The screenshot configurations.

include::partial$web-screenshot-configuration.adoc[]

include::partial$mobile-screenshot-configuration.adoc[]

.Perform visual check on establish with specified configuration
[source,gherkin]
----
When I ESTABLISH baseline with name `test` using screenshot configuration:
|scrollableElement  |webFooterToCut|webHeaderToCut|coordsProvider|
|By.xpath(.//header)|100           |100           |CEILING       |
----

=== Run visual test with specified configuration and baseline repository

Establishes baseline or compares against existing one using the specified configuration and xref:developer-guides:plugins.adoc#_baseline_repositories[baseline repository].

[source,gherkin]
----
When I $actionType baseline with name `$name` using repository `$repository` and screenshot configuration:$screenshotConfiguration
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$repository` - The name of repository. Ony `filesystem` available by the default.
* `$screenshotConfiguration` - The screenshot configurations.

include::partial$web-screenshot-configuration.adoc[]

include::partial$mobile-screenshot-configuration.adoc[]

.Perform visual check on establish with specified configuration and baseline repository
[source,gherkin]
----
When I ESTABLISH baseline with name `test` using repository `azure` and screenshot configuration:
|scrollableElement  |webFooterToCut|webHeaderToCut|coordsProvider|
|By.xpath(.//header)|100           |100           |CEILING       |
----


=== Run visual test with ignoring option

Establishes baseline or compares against existing one using the ignoring option.

[source,gherkin]
----
When I $actionType baseline with name `$name` ignoring:$ignoredElements
----

* `$actionType` - {visual-testing-actions}.
* `$name` - Then name of baseline.
* `$checkSettings` - The examples table of `ELEMENT`, `AREA`, `ACCEPTABLE_DIFF_PERCENTAGE` or `REQUIRED_DIFF_PERCENTAGE`.

.Perform visual check on compare with ignoring options
[source,gherkin]
----
When I COMPARE_AGAINST baseline with `test` ignoring:
|ELEMENT            |AREA                  |ACCEPTABLE_DIFF_PERCENTAGE|
|By.xpath(.//header)|By.cssSelector(footer)|5                         |
----

=== Run visual test with ignoring option and baseline repository

Establishes baseline or compares against existing one using the ignoring option and xref:developer-guides:plugins.adoc#_baseline_repositories[baseline repository].

[source,gherkin]
----
When I $actionType baseline with name `$name` using repository `$repository` and ignoring:$ignoredElements
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$repository` - The name of repository. Ony `filesystem` available by the default.
* `$checkSettings` - The examples table of `ELEMENT`, `AREA`, `ACCEPTABLE_DIFF_PERCENTAGE` or `REQUIRED_DIFF_PERCENTAGE`.

.Perform visual check on compare with ignoring options and baseline repository
[source,gherkin]
----
When I COMPARE_AGAINST baseline with `test` using repository `azure` and ignoring:
|ELEMENT            |AREA                  |ACCEPTABLE_DIFF_PERCENTAGE|
|By.xpath(.//header)|By.cssSelector(footer)|5                         |
----

=== Run visual test with ignoring option and specified configuration

Establishes baseline or compares against existing one using the ignoring option and the specified configuration.

[source,gherkin]
----
When I $actionType baseline with name `$name` ignoring:$ignoredElements using screenshot configuration:$screenshotConfiguration
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$checkSettings` - The examples table of `ELEMENT`, `AREA`, `ACCEPTABLE_DIFF_PERCENTAGE` or `REQUIRED_DIFF_PERCENTAGE`.
* `$screenshotConfiguration` - The screenshot configurations.

include::partial$web-screenshot-configuration.adoc[]

include::partial$mobile-screenshot-configuration.adoc[]

.Perform visual check on establish with ignoring options and specified configuration
[source,gherkin]
----
When I ESTABLISH baseline with name `test` ignoring:
|ELEMENT            |AREA                  |ACCEPTABLE_DIFF_PERCENTAGE|
|By.xpath(.//header)|By.cssSelector(footer)|5                         |
using screenshot configuration:
|scrollableElement  |webFooterToCut|webHeaderToCut|coordsProvider|
|By.xpath(.//header)|100           |100           |CEILING       |
----

=== Run visual test with ignoring option and specified configuration and baseline repository

Establishes baseline or compares against existing one using the ignoring option, the specified configuration, and xref:developer-guides:plugins.adoc#_baseline_repositories[baseline repository]..

[source,gherkin]
----
When I $actionType baseline with name `$name` using repository `$repository` and ignoring:$ignoredElements and screenshot configuration:$screenshotConfiguration
----

* `$actionType` - The {visual-testing-actions}.
* `$name` - The name of baseline.
* `$repository` - The name of repository. Ony `filesystem` available by the default.
* `$checkSettings` - The examples table of `ELEMENT`, `AREA`, `ACCEPTABLE_DIFF_PERCENTAGE` or `REQUIRED_DIFF_PERCENTAGE`.
* `$screenshotConfiguration` - The screenshot configurations.

include::partial$web-screenshot-configuration.adoc[]

include::partial$mobile-screenshot-configuration.adoc[]

.Perform visual check on establish with ignoring options and specified configuration and baseline repository
[source,gherkin]
----
When I ESTABLISH baseline with name `test` using repository `azure` and ignoring:
|ELEMENT            |AREA                  |ACCEPTABLE_DIFF_PERCENTAGE|
|By.xpath(.//header)|By.cssSelector(footer)|5                         |
and screenshot configuration:
|scrollableElement  |webFooterToCut|webHeaderToCut|coordsProvider|
|By.xpath(.//header)|100           |100           |CEILING       |
----
